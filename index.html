<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Whitestone Vaults - Performance</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background: #0e1117; color: #d4af37; font-family: Georgia, serif; text-align: center; margin: 0; padding: 20px; }
    h1 { color: #d4af37; }
    h3 { color: #d4af37; }
    .vault { background: #1c2526; border: 1px solid #d4af37; padding: 30px; margin: 20px auto; max-width: 900px; border-radius: 10px; }
    .metric { font-size: 1.8rem; margin: 15px 0; }
    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    th, td { border: 1px solid #d4af37; padding: 8px; text-align: center; }
    .chart-container { width: 80%; margin: 40px auto; }
    .footer { margin-top: 50px; font-style: italic; }
  </style>
</head>
<body>
  <h1>WHITESTONE VAULTS</h1>
  <p style="color:#d4af37;">Alpha Vault • Consistency</p>

  <div class="vault" id="report">
    <p>Loading performance data...</p>
  </div>

  <script>
    fetch('cumulative_data.json')
      .then(res => res.json())
      .then(data => {
        let html = '';
        if (data.daily_entries && data.daily_entries.length > 0) {
          let latest = data.daily_entries[data.daily_entries.length - 1];
          let total_pnl = latest.cumulative_pnl || 0;
          html = `
            <p class="metric"><strong>Cumulative PnL:</strong> $${total_pnl.toFixed(2)}</p>
            <p class="metric"><strong>From Start (${data.start_date}):</strong> $${total_pnl.toFixed(2)}</p>
          `;

          // All Trades Table
          html += `
            <h3>ALL TRADES</h3>
            <table>
              <tr><th>Gross P/L</th><th># of Trades</th><th># of Contracts</th><th>% Profitable</th><th>Expectancy</th><th>Fees & Comm.</th><th>Total P/L</th></tr>
              <tr>
                <td>$${latest.gross_pnl.toFixed(2)}</td>
                <td>${latest.trades_count}</td>
                <td>${latest.trades_count * 2.75}</td>
                <td>${latest.win_rate.toFixed(2)}%</td>
                <td>$${latest.expectancy || 'N/A'}</td>
                <td>$${latest.fees.toFixed(2)}</td>
                <td>$${latest.net_pnl.toFixed(2)}</td>
              </tr>
            </table>
          `;

          // Trades Table
          if (latest.trades && latest.trades.length > 0) {
            html += `
              <h3>TRADES</h3>
              <table>
                <tr><th>Symbol</th><th>Qty</th><th>Buy Price</th><th>Buy Time</th><th>Sell Price</th><th>P&L</th></tr>
            `;
            latest.trades.forEach(t => {
              html += `<tr><td>${t.symbol}</td><td>${t.qty}</td><td>${t.buy_price}</td><td>${t.buy_time}</td><td>${t.sell_price}</td><td>${t.pnl.toFixed(2)}</td></tr>`;
            });
            html += `</table>`;
          }

          // Charts
          let dates = data.daily_entries.map(e => e.date);
          let pnls = data.daily_entries.map(e => e.cumulative_pnl);
          html += `
            <div class="chart-container">
              <canvas id="pnlChart"></canvas>
            </div>
          `;

          document.getElementById('report').innerHTML = html;

          // P&L History Chart
          const ctx = document.getElementById('pnlChart').getContext('2d');
          new Chart(ctx, {
            type: 'line',
            data: {
              labels: dates,
              datasets: [{
                label: 'Cumulative PnL ($)',
                data: pnls,
                borderColor: '#d4af37',
                tension: 0.1,
                fill: false
              }]
            },
            options: { scales: { y: { beginAtZero: true } } }
          });

        } else {
          document.getElementById('report').innerHTML = '<p>No data yet — run the script.</p>';
        }
      })
      .catch(err => {
        document.getElementById('report').innerHTML = '<p style="color:red;">Failed to load data. Make sure cumulative_data.json exists and is valid JSON.</p>';
      });
  </script>

  <div class="footer"><em>Discipline is Luxury.</em></div>
</body>
</html>