import streamlit as st
import pdfplumber
import pandas as pd
from datetime import datetime
import plotly.express as px
import plotly.graph_objects as go

# Page config
st.set_page_config(page_title="Whitestone Vaults", layout="wide", page_icon="ðŸ’Ž")

# Custom CSS
st.markdown("""
<style>
    .main {background-color: #0e1117; color: #d4af37;}
    .stApp {background-color: #0e1117;}
    h1, h2, h3 {color: #d4af37; font-family: 'Georgia', serif; text-align: center;}
    .metric-label {color: #d4af37;}
    .metric-value {color: #ffffff; font-size: 2.5rem;}
    .vault-card {background-color: #1c2526; padding: 20px; border-radius: 10px; border: 1px solid #d4af37;}
    .footer {text-align: center; color: #d4af37; font-style: italic; margin-top: 50px;}
</style>
""", unsafe_allow_html=True)

# Title
st.markdown("<h1>WHITESTONE VAULTS</h1>", unsafe_allow_html=True)
st.markdown("<p style='text-align: center; color: #d4af37;'>London Time Â· LJD</p>", unsafe_allow_html=True)

# Upload PDF
uploaded_file = st.file_uploader("Upload Daily Performance PDF", type="pdf")

if uploaded_file is not None:
    # Parse PDF
    with pdfplumber.open(uploaded_file) as pdf:
        text = ""
        tables = []
        for page in pdf.pages:
            page_text = page.extract_text()
            if page_text:
                text += page_text + "\n"
            tables.extend(page.extract_tables())

    # Parse summary stats
    summary = {
        "gross_pnl": 0.0,
        "trades_count": 0,
        "contracts": 0,
        "win_rate": 0.0,
        "expectancy": 0.0,
        "fees": 0.0,
        "net_pnl": 0.0,
        "total_profit": 0.0,
        "winning_trades": 0,
        "winning_contracts": 0,
        "largest_win": 0.0,
        "avg_win": 0.0,
        "std_dev_win": 0.0,
        "avg_win_time": "",
        "longest_win_time": "",
        "max_runup": 0.0,
        "total_loss": 0.0,
        "losing_trades": 0,
        "losing_contracts": 0,
        "largest_loss": 0.0,
        "avg_loss": 0.0,
        "std_dev_loss": 0.0,
        "avg_loss_time": "",
        "longest_loss_time": "",
        "max_drawdown": 0.0
    }

    lines = text.splitlines()
    for line in lines:
        line = line.strip()
        if line and ' $' in line:
            parts = line.split('$')
            key = parts[0].strip()
            value = parts[1].strip().replace(',', '')
            try:
                val = float(value.replace('(', '-').replace(')', ''))
                if "Gross P/L" in key:
                    summary["gross_pnl"] = val
                elif "Total Profit" in key:
                    summary["total_profit"] = val
                elif "Total Loss" in key:
                    summary["total_loss"] = val
                elif "Trade Fees & Comm." in key:
                    summary["fees"] = val
                elif "Total P/L" in key:
                    summary["net_pnl"] = val
                elif "Largest Winning Trade" in key:
                    summary["largest_win"] = val
                elif "Largest Losing Trade" in key:
                    summary["largest_loss"] = val
                elif "Avg. Winning Trade" in key:
                    summary["avg_win"] = val
                elif "Avg. Losing Trade" in key:
                    summary["avg_loss"] = val
                elif "Std. Dev. Winning Trade" in key:
                    summary["std_dev_win"] = val
                elif "Std. Dev. Losing Trade" in key:
                    summary["std_dev_loss"] = val
                elif "Expectancy" in key:
                    summary["expectancy"] = val
                elif "Max Run-up" in key:
                    summary["max_runup"] = val
                elif "Max Drawdown" in key:
                    summary["max_drawdown"] = val
            except:
                pass

        if "% Profitable Trades" in line:
            parts = line.split()
            summary["win_rate"] = float(parts[-1].replace('%', ''))
        if "# of Trades" in line:
            parts = line.split()
            summary["trades_count"] = int(parts[-1])
        if "# of Contracts" in line:
            parts = line.split()
            summary["contracts"] = int(parts[-1])
        if "# of Winning Trades" in line:
            parts = line.split()
            summary["winning_trades"] = int(parts[-1])
        if "# of Losing Trades" in line:
            parts = line.split()
            summary["losing_trades"] = int(parts[-1])
        if "Avg. Winning Trade Time" in line:
            summary["avg_win_time"] = line.split()[-1]
        if "Avg. Losing Trade Time" in line:
            summary["avg_loss_time"] = line.split()[-1]

    # Parse trades table
    trades = []
    trades_text = text.split('TRADES')[1]
    trades_lines = trades_text.splitlines()
    i = 0
    while i < len(trades_lines):
        line = trades_lines[i].strip()
        if line and line[0].isupper() and 'NQH6' in line:  # symbol lines
            row = line.split()
            symbol = row[0]
            qty = row[1]
            buy_price = row[2]
            buy_time = ' '.join(row[3:5])  # e.g. 02/12/2026 16:18:53
            i += 1
            next_line = trades_lines[i].strip()
            duration = next_line if next_line and not next_line[0].isupper() else ''
            i += 1
            next_line = trades_lines[i].strip()
            sell_time = ' '.join(next_line.split()[:5])  # e.g. 02/12/2026 16:19:47
            sell_price = next_line.split()[-2]
            pnl = next_line.split()[-1].replace('$', '').replace('(', '-').replace(')', '')
            trades.append({
                "symbol": symbol,
                "qty": qty,
                "buy_price": buy_price,
                "buy_time": buy_time,
                "duration": duration,
                "sell_time": sell_time,
                "sell_price": sell_price,
                "pnl": float(pnl)
            })
        i += 1

    # Cumulative PnL (using net PnL)
    last_cumulative = cumulative["daily_entries"][-1]["cumulative_pnl"] if cumulative["daily_entries"] else 0.0
    cumulative_pnl = round(last_cumulative + summary["net_pnl"], 2)

    # Display Metrics
    col1, col2, col3 = st.columns(3)
    with col1:
        st.markdown(f"""
        <div class="vault-card">
            <p class="metric-label">NET PNL</p>
            <p class="metric-value">${summary['net_pnl']:.0f}</p>
        </div>
        """, unsafe_allow_html=True)

    with col2:
        weekly_return = cumulative_pnl / 1000 * 100  # placeholder, replace with real calc
        color = "#00ff00" if weekly_return >= 0 else "#ff0000"
        st.markdown(f"""
        <div class="vault-card">
            <p class="metric-label">WEEKLY RETURN</p>
            <p class="metric-value" style="color: {color};">{weekly_return:+.1f}%</p>
        </div>
        """, unsafe_allow_html=True)

    with col3:
        st.markdown(f"""
        <div class="vault-card">
            <p class="metric-label">DRAWDOWN</p>
            <p class="metric-value" style="color: #ff0000;">{summary['max_drawdown']:.1f}%</p>
        </div>
        """, unsafe_allow_html=True)

    # Vault Alpha
    st.markdown("<br>", unsafe_allow_html=True)
    st.markdown("""
    <div class="vault-card" style="text-align: center; max-width: 600px; margin: 0 auto;">
        <h3>ALPHA VAULT</h3>
        <p>CONSISTENCY</p>
    </div>
    """, unsafe_allow_html=True)

    # Equity Chart (placeholder)
    st.markdown("<br>", unsafe_allow_html=True)
    st.markdown("<h3>EQUITY</h3>", unsafe_allow_html=True)
    fig_eq = go.Figure()
    fig_eq.add_trace(go.Scatter(y=[1000, 1000 + summary['net_pnl']], line=dict(color="#d4af37", width=3)))
    fig_eq.update_layout(plot_bgcolor="#1c2526", paper_bgcolor="#1c2526", font=dict(color="#d4af37"))
    st.plotly_chart(fig_eq, use_container_width=True)

    # Trade History
    st.markdown("<br><h2>Trade History</h2>", unsafe_allow_html=True)
    trades_df = pd.DataFrame(trades)
    if not trades_df.empty:
        st.dataframe(trades_df, use_container_width=True)
    else:
        st.info("No trades found.")

    # Footer
    st.markdown("<div class='footer'><em>Discipline is Luxury.</em></div>", unsafe_allow_html=True)